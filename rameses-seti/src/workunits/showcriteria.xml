<workunit>
    <invokers>
        <invoker type="crud:showcriteria" caption="Filter" action="init" target="popup"/>
    </invokers>
    
    <code>
        <![CDATA[
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.common.*;
        
        class ShowFilterController {
        
            @Binding
            def binding;
        
            def schema;
            def handler;
            
            def controlList = [];
            def formControls = [
                getControlList: {
                    return controlList;
                }
            ] as FormPanelModel;

            def selectedField;
            def fieldList; 
            def criteriaList = []; 
                                                                                    
            void init() {
                fieldList = schema.columns.findAll{ it.indexed == 'true' };
                controlList.clear();
                if(criteriaList) {
                    controlList.addAll( criteriaList );
                }
                else {
                    addField();
                }      
            }                
               
            def doCancel() {
                return "_close";
            }                
                
            def doOk() {
                if(handler) handler(controlList);
                return "_close";
            }                      
            
            def clearFilter() {
                controlList.clear();
                if(handler) handler(controlList);
                return "_close";
            }
            
            def strOps = [
                [caption: "equals", key:"="],
                [caption: "like", key:"LIKE"],
            ];
            
            def numOps = [
                [caption: "greater than", key:">"],
                [caption: "less than", key:"<"],
                [caption: "greater than or equal to", key:">=" ],
                [caption: "less than or equal to", key:"<="],
                [caption: "equal to", key:"="],
                [caption: "between", key:"BETWEEN"],
            ];
            
            def lookupOps = [
                [caption: "is any of the ff.", key: "IN"],
                [caption: "not in any of the ff.", key:"NOT IN"],
            ];
            
            def dateOps = [
                [caption: "equals", key: "="],
                [caption: "on or before", key: "<="],
                [caption: "before", key:"<"],
                [caption: "on or after", key:">="],
                [caption: "after", key:">"],
                [caption: "between", key:"BETWEEN"],
            ];
            
            void addField() {
                String h = "criteria:item";
                def m = [type:'subform', handler:h, showCaption:false ];
                m.entry = [index:getFieldIndex()+1];
                m.properties = [
                    fieldList: fieldList, 
                    numberOperators:numOps, 
                    stringOperators: strOps,
                    entry: m.entry
                ];
                controlList << m;  
                if(binding!=null) binding.refresh();                  
            }
            
            int getFieldIndex() {
                return controlList.size();
            }
            
            void removeField(def entry) {
                def z = controlList.find{ it.entry == entry };
                controlList.remove(z);
                //recalc the index
                int fldIndex = 0;
                for( o in controlList ) {
                    fldIndex++;
                    o.entry.index = fldIndex;
                }
                if(binding!=null) binding.refresh();    
            }
            
        }
        ]]>
    </code>
    <pages>
        <page template="com.rameses.seti2.views.ShowCriteriaPanel"/>
    </pages>    
</workunit> 
